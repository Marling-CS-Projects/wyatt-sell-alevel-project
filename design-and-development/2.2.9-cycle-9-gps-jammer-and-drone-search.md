# 2.2.9 Cycle 9: GPS Jammer & Drone search

{% hint style="danger" %}
If you are prone to epileptic fits, please skip [#ui-mockup](2.2.9-cycle-9-gps-jammer-and-drone-search.md#ui-mockup "mention").
{% endhint %}

## Design

### Objectives

In this cycle I will aim to create both the GPS Jammer and Drone search items, complete with all their functionality. I will not implement merging items (as mentioned in [#item-interactions](../1-analysis/1.4a-features-of-the-proposed-solution.md#item-interactions "mention")). This will ensure that the game has additional features beyond typical "hide-and-seek" behaviour, and will mean that some of the items displayed on the map will be useful. I will also seek to implement different intensity of actions depending on the items rarity. Drone recharging will not be added in this cycle.

* [x] Create GPS Jammer item: Need to glitch map rendering on nearby Hunted clients
* [x] Create Drone search item: Need to create a heat-map display and render it to the client
* [x] Implement action intensities dependent on item rarity

### Usability

* [x] Clearly show the action intensity on the action button - for instance, a common GPS Jammer may say "JAM GPS (2 mins)" whereas an epic GPS Jammer would say "JAM GPS (10 minutes).
* [x] Show when an item is in use, i.e. with a coloured background in the inventory
* [x] Create visual or audio effects for when an item affects another player
  * [x] Drone: A quiet buzzing should be audible for nearby Hunted players
  * [x] GPS Jammer: A constant glitching animation should visible on the map screen for nearby all Hunters

### Key Variables

| Variable name  | Use                                                               |
| -------------- | ----------------------------------------------------------------- |
| item.active    | Stores a boolean value of whether or not the item is active.      |
| player.items   | Stores all items contained in a player                            |
| player.effects | Stores effects active on player - buzzing noise, or map glitching |

### Pseudocode

<pre><code><strong>subroutine on_action_click (item, player)
</strong>    send message to server
    message recieved by server
    send item-active message to requesting player
    applicable_players = get nearby players not of item.type
    send effect-active to applicable players
    
    add effect to effects of applicable_players
    set item.active = true
    
    subroutine timeout for item.effect.duration
        send an effect-disabled to players with item.effect.id in effects list
        send an item-disabled message to player
        set item.active = false
        set item.used = true
    end subroutine        
end subroutine

subroutine on_receipt_effect_active (effect)
    switch (effect)
        case 'gps-glitch'
            display map glitch overlay
        case 'drone-buzz'
            play low frequency buzz
    end switch
end subroutine</code></pre>

### UI Mockup

![](../.gitbook/assets/MOSHED-2022-9-15-14-52-57.gif)![](../.gitbook/assets/image.png)

* On the left is the intended GPS Jammer screen that will appear when the Hunter is within range of the player who triggered the GPS Jammer.
* On the right is the Drone Heatmap that will appear, where the orange blobs are where a Hunted player  could be - the false positive rate will be 80:20

## Development

### Item Infrastructure

#### Item Information

When a player views an item in their inventory, they will see a large red button with an action relevant to said item: For instance, the GPS Button says "JAM GPS" and the Drone Search Button says "DEPLOY DRONE". This is facilitated by modifying the `itemDetails` dictionary created in Cycle 8 ([#inventory-ui](2.2.8-cycle-8-item-optimisation.md#inventory-ui "mention")).

```typescript
export const itemDetails = {
  gpsj: {
    desc: 'A GPS Jammer that will disable GPS functionality for all other hunters',
    action: 'JAM GPS',
  },
  drse: {
    desc: 'A Drone that will scan the area for fugitives, and display a heatmap. Sometimes temperamental',
    action: 'DEPLOY DRONE',
  },
} as Record<Item['info']['code'], {desc: string; action: string}>;
```

Each element has a key which corresponds to a given item's code, and description and action text, which are rendered in their appropriate regions.

![](<../.gitbook/assets/localhost\_3000\_(iPhone 12 Pro) (5).png>)![](<../.gitbook/assets/localhost\_3000\_(iPhone 12 Pro) (1).png>)

{% hint style="info" %}
The item images are currently cute pictures of cats üê±, to act as placeholders. I plan to change this in a future cycle.
{% endhint %}

The duration that an item will be active for is displayed in brackets. This is implemented by adding duration information to the `Item` object, in a similar way to how I added rarity information - when creating the item, a `baseDuration` variable is defined, and is multiplied by the item's `rarity` according to the following formula:

<pre class="language-typescript"><code class="lang-typescript">const types = {
  hunted: [
    {
      name: 'GPS Jammer',
      code: 'gpsj',
<strong>      baseRarity: 1,
</strong>      baseDuration: 5,
    },
    ...
  ],
  ...
}
// rarity is defined earlier as discussed in detail in Cycle 6
const duration = item.baseDuration * (rarity - item.baseRarity + 1)</code></pre>

The `Item` object is hence modified as follows:

<pre class="language-typescript"><code class="lang-typescript"><strong>export type Item = {
</strong>  id: string;
  location: {
    lat: number;
    lng: number;
  };
  info: {
    name: string;
    code: string;
    type: 'hunter' | 'hunted';
    rarity: number;
    baseRarity: number;
    duration: number; // Added : Stores item active duration in minutes
  };
  active: boolean; // Added : Stores an items state - active or inactive
  activeStart?: number; // Added : Stores a timestamp of when an item became active
};</code></pre>

#### Item Usage

<figure><img src="../.gitbook/assets/image (4).png" alt=""><figcaption><p>A flowchart to show what happens when a player uses an item</p></figcaption></figure>

When a user clicks the use button, the server will identify the item from the id in the message and call `item.use()`:

```typescript
use(player: Player) {
  this.activeStart = Date.now();

  switch (this.info.code) {
    case 'gpsj': // GPS Jammer
      ...
      break;
    case 'drse': // Drone Search
      ...
      break;
  }
```

Several events will occur as a result of calling `item.use():`

<details>

<summary>effect-active</summary>

_Message format_

```typescript
// Using Drone Search (drse) as an example
socket.emit('effect-active', {
  id: string;
  code: 'drse'
  data: [{
    point: {lat: number, lng: number}
    intensity: number
  }, ...]
  duration: number
})
```

_Client logic_

I defined an atom (a piece of global state), called `effects`. This will store all the currently active effects on a client and allow them to be accessed from anywhere in the codebase. The `effects` list contains effect objects (as defined above).

The below function mutates the `effects` list when a new effect is received

<pre class="language-typescript"><code class="lang-typescript">'effect-active': data => {
<strong>  setEffects(prev => [...prev, data]);
</strong>},</code></pre>

</details>

<details>

<summary>effect-inactive</summary>

Within each switch-case, a `setTimeout` function will be defined, that will disable the effect once its duration has finished. One of the messages it will send is an `effect-inactive` message to all clients who received the effect

_Message format_

```typescript
socket.emit('effect-inactive', {
  id: string; // The id corresponding to the effect, and hence, the item
})
```

_Client logic_

As mentioned previously, I can mutate the `effects` atom on receipt of the above message to remove the effect from the client.

```typescript
'effect-inactive': data => {
  setEffects(prev => prev.filter(e => e.id !== data.id));
}
```

</details>

<details>

<summary>item-active</summary>

When an item is active, we simply send a confirmation to the player who activated the item with the item

```
// Some code
```

</details>

## Testing

### Evidence

{% embed url="https://drive.google.com/file/d/1LG9hiPI3MLBpxFbfUP--E9eIXpBw3R4I/view?usp=sharing" %}
